
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="nlps.html">
      
      
        <link rel="next" href="construct_own.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>7. Evolutionary Optimization - COBRA-k</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
        <script src="assets/external/unpkg.com/iframe-worker/shim.js"></script>
      
    
    
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="javascript/katex/katex.min.css">
    
      <link rel="stylesheet" href="css-extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#evolutionary-optimization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="COBRA-k" class="md-header__button md-logo" aria-label="COBRA-k" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            COBRA-k
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              7. Evolutionary Optimization
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="COBRA-k" class="md-nav__button md-logo" aria-label="COBRA-k" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    COBRA-k
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="installation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="model_from_scratch.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2. Create model from scratch
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="model_io.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3. Load/Save models
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="lps.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4. Linear Programs & Pretty-Print
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="milps.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5. Mixed-Integer Linear Programs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="nlps.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6. Nonlinear COBRA-k Programs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    7. Evolutionary Optimization
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="evolutionary.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    7. Evolutionary Optimization
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="construct_own.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8. Construct Own Optimizations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="add_data.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9. Automatic data collection
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="parameter_corrections.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10. Parameter corrections
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="utilities.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    11. More utilities
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="paper_reproduction.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    12. Paper result reproduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="evolutionary-optimization">Evolutionary optimization</h1>
<details class="abstract">
<summary>Quickstart code</summary>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.example_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">toy_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.evolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_nlp_evolutionary_optimization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.printing</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_dict</span><span class="p">,</span> <span class="n">print_optimization_result</span>

<span class="c1"># Run the evolutionary optimization, get a sorted dictionary of the form</span>
<span class="c1">#  {</span>
<span class="c1">#   $FOUND_OBJECTIVE_VALUE: [ALL_NLP_RESULTS_WITH_THIS_OBJECTIVE_VALUE],</span>
<span class="c1">#   (...)</span>
<span class="c1">#  }</span>
<span class="c1"># i.e., it contains all found objective values in descending order as keys</span>
<span class="c1"># and all NLP solutions (with all variable values) with this objective</span>
<span class="c1"># value as values.</span>
<span class="n">complete_result</span> <span class="o">=</span> <span class="n">perform_nlp_evolutionary_optimization</span><span class="p">(</span>
    <span class="n">cobrak_model</span><span class="o">=</span><span class="n">toy_model</span><span class="p">,</span>
    <span class="n">objective_target</span><span class="o">=</span><span class="s2">&quot;ATP_Consumption&quot;</span><span class="p">,</span>
    <span class="n">objective_sense</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">variability_dict</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># No variability dict given -&gt; An ecTFVA is automatically run for us</span>
<span class="p">)</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">complete_result</span><span class="p">)</span>
<span class="n">best_result</span> <span class="o">=</span> <span class="n">complete_result</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">complete_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 0-&gt;The first element is the best</span>
<span class="n">print_optimization_result</span><span class="p">(</span><span class="n">toy_model</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>

<span class="c1"># %% Postprocesing</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.evolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">postprocess</span>

<span class="n">postprocess_results</span><span class="p">,</span> <span class="n">best_postprocess_result</span> <span class="o">=</span> <span class="n">postprocess</span><span class="p">(</span>
    <span class="n">cobrak_model</span><span class="o">=</span><span class="n">toy_model</span><span class="p">,</span>
    <span class="n">opt_dict</span><span class="o">=</span><span class="n">best_result</span><span class="p">,</span>
    <span class="n">objective_target</span><span class="o">=</span><span class="s2">&quot;ATP_Consumption&quot;</span><span class="p">,</span>
    <span class="n">objective_sense</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">variability_data</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># No variability dict given -&gt; An ecTFVA is automatically run for us</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All postprocessing tries&quot;</span><span class="p">)</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">postprocess_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best postprocess result (i.e., with best objective value :-)&quot;</span><span class="p">)</span>
<span class="n">print_optimization_result</span><span class="p">(</span><span class="n">toy_model</span><span class="p">,</span> <span class="n">best_postprocess_result</span><span class="p">)</span>
</code></pre></div>
</details>
<h2 id="introduction">Introduction</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Also check out another toy model evolution example in COBRA-k's repository which you may find
under <code>examples/toymodel/run_toymodel_calculations.py</code>.</p>
</div>
<p>As mentioned in the previous chapter, both the global MINLP and the local NLP have major disadvantages:</p>
<ul>
<li>The MINLP quickly becomes way too slow with increasing model size</li>
<li>The NLP is quick, but only works for one selected set of thermodynamically feasible reactions (i.e. reactions with <span class="arithmatex">\(f_i&gt;0\)</span>)</li>
</ul>
<p>To overcome these disadvantages, COBRA-k provides an efficient and often quite quick evolutionary algorithm <a href="https://en.wikipedia.org/wiki/Evolutionary_algorithm">[Wikipedia]</a>. This evolutionary algorithm allows one to quite quickly optmize a COBRA-k Model with a full integration of non-linear thermodynamic and kinetic constraints.</p>
<div class="admonition warning">
<p class="admonition-title">Global solutions</p>
<p>The evolutionary algorithm cannot <em>guarantee</em> that the found solution is global. Hence, it is advisable to let it run until no improvement can be found over a set amount of rounds (see below). Nevertheless, any solution found by the evolutionary algorithm is <em>valid</em> and a solution to the given constraints, just maybe not one that is globally optimal.</p>
<p>For a higher confidence in a found result, it is advisable to run multiple evolutionary optimizations with the same objective function. If the returned results are the same or at least nearly identical, the confidence in the result may rise.</p>
</div>
<h1 id="the-evolutionary-algorithm">The evolutionary algorithm</h1>
<h3 id="input">Input</h3>
<p>As <em>obligatory</em> input, COBRA-k's evolutionary algorithm takes:</p>
<ul>
<li>A <em>COBRA-k Model</em>, including all its kinetic and thermodynamic parameters</li>
<li>An <em>objective target</em>, which can be - as for linear optmizations (see LP chapter) - either a single model variable ID (<code>str</code>) or a linear term of multiple model variables (<code>dict[str, float]</code>). As with all other optmizations, the objective target can be any kind of model variable, including fluxes, concentrations, κ and γ values etc.</li>
<li>An <em>objective sense</em>, i.e. either a minimization (-1) or maximization (+1) of a value.</li>
<li>Furthermore, COBRA-k's evolutionary algorithm provides many further <em>optional</em> inputs. These include e.g. whether or not κ and/or γ constraints shall be regarded and solver settings. For more, see this documentation's API reference for the submodule <code>evolution</code>.</li>
</ul>
<p>COBRA-k's evolutionary algorithm itself is composed of the following main steps:</p>
<ol>
<li>Preparatory Variability Analysis - to find variable bounds</li>
<li>Initialization - to find some feasbile solutions as starting points</li>
<li>Evolutionary Run - to find a (hopefully) optimal solution</li>
</ol>
<p>The next sub-paragraphs explain these steps in more detail.</p>
<h3 id="preparatory-variability-analysis">Preparatory Variability Analysis</h3>
<p>Again, as we use the NLP, we have to run the preparatory variability analysis as explained in the previous chapter. In COBRA-k, you do not have to call this variability analysis separately in your code as such a variablity analysis is automatically calculated if you do not provide already existing variability data.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As for the NLP (see NLP chapter), this preparatory variability analysis is essential to avoid non-linear solver errors.</p>
</div>
<h3 id="initialization">Initialization</h3>
<p>Using the mentioned input values, the following routines are run for our initializing sampling:</p>
<ol>
<li>We have a given (e.g. randomly selected) set of enforced deactivated reactions (i.e. <span class="arithmatex">\(v_i=0\)</span>).</li>
<li>A first ecTFBA (see MILP chapter) is run with the COBRA-k Model and the given objective function. From this first ecTFBA, we store the objective value.</li>
<li>Using the objective value from the previous step, we now maximize the number of thermodynamically active reactions, i.e. <span class="arithmatex">\(max \sum{z_i}\)</span> with an ecTFBA. We store the resulting flux pattern (i.e. all resulting active reactions).</li>
<li>Using the flux pattern from the previous step, we create a reduced COBRA-k model where no inactive reactions (i.e. <span class="arithmatex">\(v_i=0\)</span> in the flux pattern) occur.</li>
<li>Using this reduced COBRA-k model, we now run our fast NLP with the general input objective function. We return the objective value.</li>
<li>Exception step: If any of the previous optmizations results in infeasibility (i.e. no solution can be found with the given set of deavtivated reactions), we return an appropriate signal to let us know that.</li>
</ol>
<p>If enough feasible solutions are found in a given maximal number of initializing sampling rounds (all which can be set in COBRA-k's evolution method), we now have an initializing set of feasible flux distributions and associated objective values.</p>
<h3 id="evolutionary-run">Evolutionary run</h3>
<p>Now that we have variable bounds (from the preparatory variability analysis) and some feasible starting points (from the initialization), we can call the actual evolutionary run. The evolutionary run consists of an outer and an inner optimization, as well as a small preparatory calculations:</p>
<h4 id="identification-of-stoichiometric-couples">Identification of stoichiometric couples</h4>
<p>First, we identify all stoichiometric couples in our model's stoichiometric matrix. Such couples are reactions which <em>always</em> have to be active or inactive together. E.g. if we have a linear pathway such as -&gt;A-&gt;B-&gt;C-&gt;, then all reactions have to be active together in order to achieve a steady-state.</p>
<h4 id="outer-optimization">Outer optimization</h4>
<p>The <em>outer</em> optimization is affecting a binary (or <span class="arithmatex">\(\[0,1\]\)</span>) vector which we'll call <span class="arithmatex">\(\mathbf{β}\)</span>. This vector is as long as the number of the previously identified stoichiometric couples. If an element <span class="arithmatex">\(i\)</span> of <span class="arithmatex">\(\mathbf{β}\)</span> is 0 (or close to 0), then the flux of all reactions in the respective <span class="arithmatex">\(i\)</span>th stoichiometric couple is set to 0. Otherwise, the reactions are allowed to run.</p>
<p><span class="arithmatex">\(\mathbf{β}\)</span> is optmized through a genetic algorithm <a href="https://en.wikipedia.org/wiki/Genetic_algorithm">[Wikipedia]</a>. This algorithm works in <em>rounds</em> and has a given <em>population (or candidate) size</em>:</p>
<ol>
<li>In each round, as many inner optimizations (see next subparagraph) as there are population members are run. Thus, we actually have as many <span class="arithmatex">\(\mathbf{β}\)</span> as there are population members.</li>
<li>Then, the fitnesses (here, the final NLP optimization value from the inner optimizations) are collected for each population member.</li>
<li>Using these fitness values, the <span class="arithmatex">\(\mathbf{β}\)</span> of the population members are mutated according to the genetic algorithm, with the intention and hope that better <span class="arithmatex">\(\mathbf{β}\)</span> are found. Then, we start again with step 1 unless the maximal number of rounds or the maximal number of rounds without an increase in the best optimal value is reached.</li>
</ol>
<h4 id="inner-optimization">Inner optimization</h4>
<p>The <em>inner</em> optimization consists of two ecTFBAs (see MILP chapter) and a subsequent NLP (see NLP chapter):</p>
<ol>
<li>The first ecTFBA maximizies our objective.</li>
<li>The second ecTFBA maximizied the number of thermodynamically feasible active reactions under our previously calculated objective value. This allows to find solutions which need more than a minimal or near-minimal set of active reactions.</li>
<li>The NLP is then run on all active reactions of the last ecTFBA and returns a fitness value :-)</li>
</ol>
<p>If any of these three steps shows that there is an infeasiblity, an infeasibility signal is sent to the outer optimization.</p>
<h2 id="running-an-evolutionary-optimization-in-cobra-k">Running an evolutionary optimization in COBRA-k</h2>
<p>Now let's run an evolutionary optimization with our toy model, which is much simpler to do than to describe the many steps of the algorithm :-) COBRA-k has all its evolutionary algorithm functionality in the ``evolution```subpackage.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.example_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">toy_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.evolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">perform_nlp_evolutionary_optimization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.printing</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_dict</span><span class="p">,</span> <span class="n">print_optimization_result</span>

<span class="c1"># Run the evolutionary optimization, get a sorted dictionary of the form</span>
<span class="c1">#  {</span>
<span class="c1">#   $FOUND_OBJECTIVE_VALUE: [ALL_NLP_RESULTS_WITH_THIS_OBJECTIVE_VALUE],</span>
<span class="c1">#   (...)</span>
<span class="c1">#  }</span>
<span class="c1"># i.e., it contains all found objective values in descending order as keys</span>
<span class="c1"># and all NLP solutions (with all variable values) with this objective</span>
<span class="c1"># value as values.</span>
<span class="n">complete_result</span> <span class="o">=</span> <span class="n">perform_nlp_evolutionary_optimization</span><span class="p">(</span>
    <span class="n">cobrak_model</span><span class="o">=</span><span class="n">toy_model</span><span class="p">,</span>
    <span class="n">objective_target</span><span class="o">=</span><span class="s2">&quot;ATP_Consumption&quot;</span><span class="p">,</span>
    <span class="n">objective_sense</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">variability_dict</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># No variability dict given -&gt; An ecTFVA is automatically run for us</span>
<span class="p">)</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">complete_result</span><span class="p">)</span>
<span class="n">best_result</span> <span class="o">=</span> <span class="n">complete_result</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">complete_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 0-&gt;The first element is the best</span>
<span class="n">print_optimization_result</span><span class="p">(</span><span class="n">toy_model</span><span class="p">,</span> <span class="n">best_result</span><span class="p">)</span>
</code></pre></div>
<p>COBRA-k's <code>perform_nlp_evolutionary_optimization</code>function has many more possible parameters (see also the following info box), which you can look up in this documentation's API overview for the <code>evolution</code>module.</p>
<div class="admonition info">
<p class="admonition-title">Working with larger models</p>
<p>The evolutionary algorithm can also work efficiently with much larger models. E.g. in COBRA-k's initial publication <a href="">[Paper]</a>, the mid-scale model iCH360 <a href="">[Paper]</a> was succesfully used. iCH360 consists of hundreds of reactions and metabolites.</p>
<p>If you have trouble finding a good objective value from the evolutionary algorithm for your model, consider trying out different population sizes (through the <code>perform_nlp_evolutionary_optimization</code> parameter <code>pop_size</code>, which defaults to your computer's number of CPU cores) and the <code>evolution_num_gens</code>total evolutionary rounds parameter. Usually, the more population members and the more rounds, the better the optimization should become, at the expense of more needed computational time.</p>
</div>
<h2 id="postprocessing">Postprocessing</h2>
<p>Oftentimes, the genetic algorithm may fail to identify better sets of active reactions that only <em>slightly</em> differ from the best found solution. To mitigate this problem, COBRA-k also provides a postprocessing routine, which simply looks for single (and a low number of) reaction inactivations and activations, trying to identify better solutions. Here's how to use its functionality in COBRA-k:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...continuing from the previous code block</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cobrak.evolution</span><span class="w"> </span><span class="kn">import</span> <span class="n">postprocess</span>

<span class="n">postprocess_results</span><span class="p">,</span> <span class="n">best_postprocess_result</span> <span class="o">=</span> <span class="n">postprocess</span><span class="p">(</span>
    <span class="n">cobrak_model</span><span class="o">=</span><span class="n">toy_model</span><span class="p">,</span>
    <span class="n">opt_dict</span><span class="o">=</span><span class="n">best_result</span><span class="p">,</span>
    <span class="n">objective_target</span><span class="o">=</span><span class="s2">&quot;ATP_Consumption&quot;</span><span class="p">,</span>
    <span class="n">objective_sense</span><span class="o">=+</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">variability_data</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># No variability dict given -&gt; An ecTFVA is automatically run for us</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All postprocessing tries&quot;</span><span class="p">)</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">postprocess_results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best postprocess result (i.e., with best objective value :-)&quot;</span><span class="p">)</span>
<span class="n">print_optimization_result</span><span class="p">(</span><span class="n">toy_model</span><span class="p">,</span> <span class="n">best_postprocess_result</span><span class="p">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In our toy model, the postprocessing does not lead to a better solution as the genetic algorithm
already found the optimal solution. However, in larger models, it is strongly advised to double-check
your genetic algorithm results through running the postprocessing.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.92b07e13.min.js"></script>
      
        <script src="javascript/katex/katex.min.js"></script>
      
        <script src="javascript/katex/contrib/auto-render.min.js"></script>
      
        <script src="javascript/init_katex.js"></script>
      
        <script src="assets/external/unpkg.com/mermaid@11/dist/mermaid.min.js"></script>
      
    
  </body>
</html>